<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>TMDB to Blogger</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; }
    input, button { padding: 10px; margin: 5px; }
    .suggestions { background: white; border: 1px solid #ccc; position: absolute; z-index: 10; width: 300px; }
    .suggestions div { padding: 5px; cursor: pointer; }
    .suggestions div:hover { background: #eee; }
  </style>
</head>
<body>

<h2>ابحث عن فيلم</h2>
<input type="text" id="search" placeholder="اكتب اسم الفيلم...">
<div id="suggestions" class="suggestions"></div>
<button onclick="handleAuthClick()">تسجيل الدخول لجوجل</button>
<button onclick="publishPost()">نشر في بلوجر</button>

<script>
const apiKey = '4b1125dc507cd0f303b025b30d6311dd';
const clientId = '6996456913-t6ceju8vos0icbev531e7iqdrtm7g7u4.apps.googleusercontent.com';
const blogId = '277624714973052630';
const scope = 'https://www.googleapis.com/auth/blogger';
let tokenClient;
let gapiInited = false;
let gisInited = false;
let selectedMovie;

function createHTMLFromMovie(movie, details, credits, trailerKey) {
  const genres = details.genres.map(g => `<a href="#">${g.name}</a>`).join(' ');
  const actors = credits.cast.slice(0, 5).map(actor => `
    <div>
      <div class="owl-actors-box">
        <div class="owl-actors-thumb">
          <img src="https://image.tmdb.org/t/p/w300${actor.profile_path}" alt="${actor.name}">
        </div>
        <span>${actor.name}</span>
      </div>
    </div>
  `).join('');

  return `
  <div class="post-single">
    <div class="container">
      <div class="single-poster">
        <div class="separator" style="clear: both;"><a href="https://image.tmdb.org/t/p/original${movie.poster_path}" style="display: block; padding: 1em 0; text-align: center; "><img alt="" border="0" src="https://image.tmdb.org/t/p/original${movie.poster_path}"/></a></div>
      </div>
      <div class="post-single-content">
        <h1>مشاهدة فيلم ${details.title} مترجم</h1>
        <h2><span>بالعربي :</span> ${details.original_title}</h2>
        <div class="post-Inner"></div>
        <div class="post-single-watching">
          <div class="story">
            <h2>القصة</h2>
            <p>${details.overview}</p>
          </div>
        </div>
        <ul class="post-information-list">
          <li><span>الجودة :</span><a href="#">HD</a></li>
          <li><span>القسم :</span><a href="#">افلام اجنبية</a></li>
          <li><span>السنة :</span><a href="#">${details.release_date.split('-')[0]}</a></li>
          <li><span>النوع :</span>${genres}</li>
        </ul>
        <div class="post-actors" dir="ltr">
          <h4><span>فريق</span> <em>العمل</em></h4>
          <div class='owl-carousel' id='owl-slide'>${actors}</div>
        </div>
      </div>

      <div class="post-single-side">
        <div class="StatsMain">
          <div class="SingleContentSideTitle">
            <span>مشاهدة العرض</span>
            <a target="_blank" class="IMDBButton" href="https://www.imdb.com/title/${details.imdb_id}/">
              <em>علي</em>IMDb
            </a>
          </div>
        </div>
        <a href="#TrailerPopoverInner">
          <div class="dropbtn WatchingArea TrailerColorButton Hoverable">
            <span><i class="fa fa-youtube-play"></i> مشاهدة إعلان العرض<i class="fa fa-angle-left"></i></span>
          </div>
        </a>
        <a href="https://cinema4ueg.blogspot.com/p/${details.title.replace(/\s+/g,'-').toLowerCase()}.html">
          <div class="WatchingArea Hoverable">
            <span class="WatchNow"><em class="WatchIcon"></em> مشاهدة و تحميل الآن <i class="fa fa-angle-left"></i></span>
          </div>
        </a>
        <div class="ImportantButtons">
          <div class="FavoriteButton">
            <a href="#" target="_blank" class='Hoverable'><i class="fa fa-star-o"></i><span>جميع أجزاء الفيلم</span></a>
          </div>
          <div class="ReportButton">
            <a href="#" target="_blank" class='Hoverable'><i class="fa fa-flag"></i><span>تبليغ عن الرابط</span></a>
          </div>
        </div>
      </div>

      <div class="TrailerPopover dropdown-content" id="myTrailer">
        <div class="TrailerPopoverInner" id="TrailerPopoverInner">
          <iframe src="https://www.youtube.com/embed/${trailerKey}" allowfullscreen width="100%" height="100%"></iframe>
        </div>
      </div>
    </div>
  </div>
  `;
}

async function fetchMovieDetails(id) {
  const [detailsRes, creditsRes, videoRes] = await Promise.all([
    fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}&language=ar`),
    fetch(`https://api.themoviedb.org/3/movie/${id}/credits?api_key=${apiKey}&language=ar`),
    fetch(`https://api.themoviedb.org/3/movie/${id}/videos?api_key=${apiKey}&language=ar`)
  ]);
  const details = await detailsRes.json();
  const credits = await creditsRes.json();
  const videos = await videoRes.json();
  const trailer = videos.results.find(v => v.type === 'Trailer');
  return createHTMLFromMovie(selectedMovie, details, credits, trailer?.key || '');
}

async function publishPost() {
  const htmlContent = await fetchMovieDetails(selectedMovie.id);
  const token = gapi.client.getToken().access_token;

  const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      title: selectedMovie.title,
      content: htmlContent
    })
  });

  const data = await res.json();
  alert('تم النشر: ' + data.url);
}

document.getElementById('search').addEventListener('input', async (e) => {
  const query = e.target.value;
  const suggestionsBox = document.getElementById('suggestions');
  if (!query) return suggestionsBox.innerHTML = '';

  const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}&language=ar`);
  const data = await res.json();

  suggestionsBox.innerHTML = data.results.slice(0, 5).map(movie => `
    <div onclick='selectMovie(${JSON.stringify(movie)})'>${movie.title} (${movie.release_date?.split('-')[0] || '??'})</div>
  `).join('');
});

function selectMovie(movie) {
  selectedMovie = movie;
  document.getElementById('search').value = movie.title;
  document.getElementById('suggestions').innerHTML = '';
}

window.onload = () => {
  gapi.load('client', () => {
    gapi.client.init({}).then(() => gapiInited = true);
  });
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope,
    callback: (tokenResponse) => {
      gapi.client.setToken(tokenResponse);
      alert('تم تسجيل الدخول بنجاح');
    }
  });
};

function handleAuthClick() {
  tokenClient.requestAccessToken();
}
</script>
</body>
</html>
