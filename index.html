<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>TMDB to Blogger</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f0f0;
      padding: 20px;
      direction: rtl;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-family: 'Cairo', sans-serif;
    }
    .suggestions {
      background: white;
      border: 1px solid #ccc;
      position: absolute;
      z-index: 10;
      width: 300px;
      max-height: 300px;
      overflow-y: auto;
    }
    .suggestions div {
      padding: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .suggestions div:hover {
      background: #eee;
    }
    .suggestions img {
      width: 40px;
      height: auto;
      margin-left: 10px;
      border-radius: 4px;
    }
    #loadingSpinner {
      display: none;
      margin-top: 10px;
      color: #333;
      font-weight: bold;
    }
    #postsList {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .post-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .post-item:last-child { border-bottom: none; }
    .post-item button {
      margin-left: 5px;
    }
  </style>
</head>
<body>

<h2>Ø§Ø¨Ø­Ø« Ø¹Ù† ÙÙŠÙ„Ù…</h2>
<input type="text" id="search" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù…...">
<div id="suggestions" class="suggestions"></div>
<button onclick="handleAuthClick()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¬ÙˆØ¬Ù„</button>
<div id="loadingSpinner">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...</div>

<div id="postsList">
  <h3>Ø¢Ø®Ø± Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª</h3>
  <div id="postsContainer"></div>
  <button onclick="loadMorePosts()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
</div>

<script>
const apiKey = '4b1125dc507cd0f303b025b30d6311dd';
const blogId = '277624714973052630';
const clientId = '6996456913-t6ceju8vos0icbev531e7iqdrtm7g7u4.apps.googleusercontent.com';
const scope = 'https://www.googleapis.com/auth/blogger';

let gapiInited = false;
let tokenClient;
let selectedMovie = null;

const searchInput = document.getElementById('search');
const suggestionsBox = document.getElementById('suggestions');
let debounceTimer;

searchInput.addEventListener('input', () => {
  const query = searchInput.value.trim();
  suggestionsBox.innerHTML = '';
  if (!query) {
    suggestionsBox.style.display = 'none';
    return;
  }

  suggestionsBox.innerHTML = '<div>ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...</div>';
  suggestionsBox.style.display = 'block';

  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => searchMovies(query), 500);
});

async function searchMovies(query) {
  try {
    const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`);
    const data = await res.json();

    if (!data.results || data.results.length === 0) {
      suggestionsBox.innerHTML = '<div>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…</div>';
      return;
    }

    suggestionsBox.innerHTML = '';
    data.results.slice(0, 7).forEach(movie => {
      const year = movie.release_date ? movie.release_date.slice(0, 4) : 'N/A';
      const div = document.createElement('div');
      div.innerHTML = `
        <img src="https://image.tmdb.org/t/p/w92${movie.poster_path}" alt="${movie.title}">
        <span>${movie.title} (${year})</span>
        <button onclick="publishMovie(${movie.id})">Ù†Ø´Ø±</button>
      `;
      suggestionsBox.appendChild(div);
    });
  } catch (err) {
    suggestionsBox.innerHTML = '<div>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</div>';
  }
}

async function publishMovie(movieId) {
  document.getElementById('loadingSpinner').style.display = 'block';
  const res = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${apiKey}&append_to_response=videos`);
  const movie = await res.json();

  const year = movie.release_date ? movie.release_date.slice(0, 4) : 'N/A';
  const title = movie.title;
  const overview = movie.overview;
  const poster = `https://image.tmdb.org/t/p/w500${movie.poster_path}`;
  const youtubeKey = movie.videos.results.find(v => v.site === 'YouTube')?.key || '';

  const content = `
    <h2>${title} (${year})</h2>
    <img src="${poster}" style="max-width:100%" />
    <p>${overview}</p>
    ${youtubeKey ? `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${youtubeKey}" frameborder="0" allowfullscreen></iframe>` : ''}
    <p><a href="https://alexbesteg.blogspot.com/search/label/${year}" target="_blank">Ø£ÙÙ„Ø§Ù… ${year}</a></p>
  `;

  const token = gapi.client.getToken()?.access_token;
  if (!token) return;

  await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      title,
      content
    })
  });

  document.getElementById('loadingSpinner').style.display = 'none';
  alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„ÙÙŠÙ„Ù… Ø¨Ù†Ø¬Ø§Ø­');
  loadPosts();
}

let posts = [];
let displayedCount = 0;

async function loadPosts() {
  const token = gapi.client.getToken()?.access_token;
  if (!token) return;

  const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const data = await res.json();
  posts = data.items || [];
  displayedCount = 0;
  document.getElementById('postsContainer').innerHTML = '';
  renderPosts();
}

function renderPosts() {
  const container = document.getElementById('postsContainer');
  const postsToShow = posts.slice(displayedCount, displayedCount + 5);
  postsToShow.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post-item';
    div.innerHTML = `
      <span>${post.title}</span>
      <div>
        <button onclick="window.open('${post.url}', '_blank')">Ø¹Ø±Ø¶</button>
        <button onclick="copyLink('${post.url}')">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <button onclick="deletePost('${post.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    container.appendChild(div);
  });
  displayedCount += postsToShow.length;
}

function loadMorePosts() {
  renderPosts();
}

function copyLink(url) {
  navigator.clipboard.writeText(url).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
}

async function deletePost(id) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
  const token = gapi.client.getToken()?.access_token;
  if (!token) return;
  await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/${id}`, {
    method: 'DELETE',
    headers: { 'Authorization': `Bearer ${token}` }
  });
  posts = posts.filter(p => p.id !== id);
  document.getElementById('postsContainer').innerHTML = '';
  displayedCount = 0;
  renderPosts();
}

function handleAuthClick() {
  if (!tokenClient) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªÙ‡ÙŠØ¦Ø© Google API');
    return;
  }
  tokenClient.requestAccessToken();
}

window.onload = () => {
  gapi.load('client', async () => {
    await gapi.client.init({});
    gapiInited = true;
  });

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope,
    callback: (tokenResponse) => {
      gapi.client.setToken(tokenResponse);
      alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
      loadPosts();
    }
  });
};
</script>
</body>
</html>
